//Not the actual apps script, just a copy of it

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const gamesSheet  = ss.getSheetByName('Games');
  const ownersSheet = ss.getSheetByName('Owners'); // <- new sheet

  const type = (e.parameter && e.parameter.type) || 'games'; // default

  Logger.log('Event object: ' + JSON.stringify(e));
  Logger.log('Raw postData: ' + (e.postData && e.postData.contents));

  let data = {};
  try {
    data = JSON.parse(e.postData.contents || '{}');
  } catch (err) {
    Logger.log('JSON parse error: ' + err);
  }

  Logger.log('Parsed data: ' + JSON.stringify(data));

  if (type === 'owners') {
    // Sheet "Owners": A: Name, B: Avatar URL
    ownersSheet.appendRow([
      data.name      || '',
      data.avatarUrl || '',
    ]);
  } else {
    // Determine whether the sheet already has an ExpansionOf column by checking headers
    const headerRow = gamesSheet.getDataRange().getValues()[0] || [];
    const headerNames = headerRow.map(h => String(h || '').toLowerCase());
    const hasExpansionCol = headerNames.some(h => h.indexOf('expansion') !== -1);

    if (hasExpansionCol) {
      // Columns include ExpansionOf
      gamesSheet.appendRow([
        data.name         || '',
        data.description  || '',
        data.owners       || '',
        data.playerCount  || '',
        data.playtime     || '',
        data.genre        || '',
        data.notes        || '',
        data.imageUrl     || '',
        data.scoreSheet   || '',
        data.expansionOf  || '',
        data.timestamp    || ''
      ]);
    } else {
      // Older sheet layout: append without ExpansionOf (preserve timestamp position)
      gamesSheet.appendRow([
        data.name        || '',
        data.description || '',
        data.owners      || '',
        data.playerCount || '',
        data.playtime    || '',
        data.genre       || '',
        data.notes       || '',
        data.imageUrl    || '',
        data.scoreSheet  || '',
        data.timestamp   || ''
      ]);
    }
  }

  return ContentService
    .createTextOutput(JSON.stringify({ result: 'success' }))
    .setMimeType(ContentService.MimeType.JSON);
}


function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const gamesSheet  = ss.getSheetByName('Games');
  const ownersSheet = ss.getSheetByName('Owners');

  const type = (e.parameter && e.parameter.type) || 'games'; // default

  if (type === 'owners') {
    // Return owners
    const range  = ownersSheet.getDataRange();
    const values = range.getValues(); // [ [header...], [row1...], ... ]

    const rows = values.slice(1)       // skip header
      .filter(r => r[0])              // skip empty name
      .map(r => ({
        name:      r[0],
        avatarUrl: r[1],
      }));

    return ContentService
      .createTextOutput(JSON.stringify(rows))
      .setMimeType(ContentService.MimeType.JSON);

  } else {
    // Existing behaviour for games
    const range  = gamesSheet.getDataRange();
    const values = range.getValues();

    // Inspect headers to see where ExpansionOf/timestamp live. This makes the API resilient
    const headers = values[0] || [];
    const headerLower = headers.map(h => String(h || '').toLowerCase());
    const expansionIdx = headerLower.findIndex(h => h.indexOf('expansion') !== -1);
    const timestampIdx = headerLower.findIndex(h => h.indexOf('timestamp') !== -1);

    const rows = values.slice(1)
      .filter(r => r[0])
      .map(r => {
        const base = {
          gameName:   r[0],
          description:r[1],
          owners:     r[2],
          players:    r[3],
          playtime:   r[4],
          genre:      r[5],
          notes:      r[6],
          imageUrl:   r[7],
          scoreSheet: r[8],
        };
        // If ExpansionOf column exists in header, use that index; otherwise assume older layout (timestamp at index 9)
        if (expansionIdx >= 0) {
          base.expansionOf = r[expansionIdx] || '';
        } else {
          base.expansionOf = '';
        }

        if (timestampIdx >= 0) {
          base.timestamp = r[timestampIdx] || '';
        } else {
          base.timestamp = r[9] || '';
        }

        return base;
      });

    return ContentService
      .createTextOutput(JSON.stringify(rows))
      .setMimeType(ContentService.MimeType.JSON);
  }
}