<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk of Rain 2 | Item Cheat Sheet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="hero">
    <div>
      <p class="eyebrow">Risk of Rain 2</p>
      <h1>Item Cheat Sheet</h1>
      <p class="lede">All items on one screen. Toggle filters, hide disabled entries, click any icon for details.</p>
    </div>
    <div class="hero-card">
      <p class="card-label">Quick Stats</p>
      <div class="stat-line"><span data-result-count>0</span><small>items visible</small></div>
      <div class="stat-line"><span data-active-count>0</span><small>equipment visible</small></div>
    </div>
  </header>

  <main class="content">
    <section class="filters">
      <div class="filter-block">
        <label for="search">Search</label>
        <div class="search-bar">
          <input id="search" type="search" placeholder="Search by name, quote, or description...">
          <span class="kbd">Ctrl + F</span>
        </div>
      </div>

      <div class="filter-block">
        <label>Rarity (toggle)</label>
        <div class="chips" id="rarityFilters">
          <button class="chip is-active" data-rarity="all">All</button>
          <button class="chip" data-rarity="Common">Common</button>
          <button class="chip" data-rarity="Uncommon">Uncommon</button>
          <button class="chip" data-rarity="Legendary">Legendary</button>
          <button class="chip" data-rarity="Boss">Boss</button>
          <button class="chip" data-rarity="Void">Void</button>
          <button class="chip" data-rarity="Meal">Meal</button>
          <button class="chip" data-rarity="Lunar">Lunar</button>
          <button class="chip" data-rarity="Lunar Equipment">Lunar Equipment</button>
          <button class="chip" data-rarity="Equipment">Equipment</button>
          <button class="chip" data-rarity="Elite Equipment">Elite Equipment</button>
        </div>
      </div>

      <div class="filter-block">
        <label>Type (toggle)</label>
        <div class="chips" id="typeFilters">
          <button class="chip is-active" data-type="all">All</button>
          <button class="chip" data-type="item">Items</button>
          <button class="chip" data-type="equipment">Equipment</button>
        </div>
      </div>

      <div class="filter-block">
        <label>Sort (toggle)</label>
        <div class="chips" id="sortToggles">
          <button class="chip is-active" data-sort="rarity">Rarity order</button>
          <button class="chip" data-sort="name">Name A → Z</button>
          <button class="chip" data-sort="id">ID A → Z</button>
        </div>
      </div>
    </section>

    <section class="grid" id="itemsGrid" aria-live="polite">
      <div class="loading">Loading ror2_items_and_equipments.json...</div>
    </section>
  </main>

  <template id="itemCardTemplate">
    <article class="item-card" role="button" tabindex="0" aria-label="Open item details">
      <div class="item-icon" aria-hidden="true"></div>
    </article>
  </template>

  <div class="modal is-hidden" id="itemModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <button class="modal-close" aria-label="Close">×</button>
      <div class="modal-header">
        <div class="modal-icon"></div>
        <div>
          <p class="modal-rarity"></p>
          <h2 id="modalTitle" class="modal-title"></h2>
          <p class="modal-type"></p>
        </div>
      </div>
      <p class="modal-desc"></p>
    </div>
  </div>

  <script>
    const rarityConfig = {
      common: { color: '#dfe6ed', accent: '#a5b7c6' },
      uncommon: { color: '#c7f5c4', accent: '#5cd475' },
      legendary: { color: '#ffd6d9', accent: '#f4555d' },
      boss: { color: '#fff3c4', accent: '#f4c84a' },
      void: { color: '#ead9ff', accent: '#a175ff' },
      meal: { color: '#ffe0c2', accent: '#ff9b42' },
      lunar: { color: '#d6e9ff', accent: '#6ab7ff' },
      'lunar equipment': { color: '#d6e9ff', accent: '#4c9aff' },
      equipment: { color: '#ffe0c2', accent: '#ff7a42' },
      'elite equipment': { color: '#ffe0c2', accent: '#ff4d42' },
      default: { color: '#e2e8f0', accent: '#94a3b8' },
    };

    const rarityOrder = [
      'Common',
      'Uncommon',
      'Legendary',
      'Boss',
      'Void',
      'Meal',
      'Lunar',
      'Lunar Equipment',
      'Equipment',
      'Elite Equipment',
    ];

    const state = {
      raritySelection: new Set(),
      typeSelection: new Set(),
      search: '',
      sort: { rarity: true, key: 'id' }, // rarity toggle + secondary key (name or id)
    };

    const itemsGrid = document.getElementById('itemsGrid');
    const rarityFilters = document.getElementById('rarityFilters');
    const typeFilters = document.getElementById('typeFilters');
    const sortToggles = document.getElementById('sortToggles');
    const searchInput = document.getElementById('search');
    const cardTemplate = document.getElementById('itemCardTemplate');
    const modal = document.getElementById('itemModal');
    const modalTitle = modal.querySelector('.modal-title');
    const modalDesc = modal.querySelector('.modal-desc');
    const modalRarity = modal.querySelector('.modal-rarity');
    const modalType = modal.querySelector('.modal-type');
    const modalIcon = modal.querySelector('.modal-icon');

    let items = [];

    const slugify = (value = '') => value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    const buildIconPath = (name = '') => `icons/${name.replace(/\s+/g, '_')}.png`;

    const rarityToKey = (rarity = '') => {
      const raw = slugify(rarity).replace(/-/g, ' ');
      return raw || 'default';
    };

    const describeType = (type) => (type === 'equipment' ? 'Equipment' : 'Item');

    const formatRichText = (value = '') => {
      const esc = (str) => str.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      let output = esc(value);
      output = output.replace(/{{Color\|([^|]+)\|([^}]+)}}/gi, (_, tone, text) => {
        const key = tone.toLowerCase();
        const cls = `text-${key}`;
        return `<span class="${cls}">${esc(text)}</span>`;
      });
      output = output.replace(/{{Stack\|([^}]+)}}/gi, (_, text) => `<span class="text-stack">${esc(text)}</span>`);
      return output;
    };

    const syncChipStates = () => {
      // Rarity chips
      rarityFilters.querySelectorAll('.chip').forEach((chip) => {
        if (chip.dataset.rarity === 'all') {
          chip.classList.toggle('is-active', state.raritySelection.size === 0);
        } else {
          chip.classList.toggle('is-active', state.raritySelection.has(chip.dataset.rarity));
        }
      });

      // Type chips
      typeFilters.querySelectorAll('.chip').forEach((chip) => {
        if (chip.dataset.type === 'all') {
          chip.classList.toggle('is-active', state.typeSelection.size === 0);
        } else {
          chip.classList.toggle('is-active', state.typeSelection.has(chip.dataset.type));
        }
      });

      // Sort toggles
      sortToggles.querySelectorAll('.chip').forEach((chip) => {
        const key = chip.dataset.sort;
        if (key === 'rarity') {
          chip.classList.toggle('is-active', state.sort.rarity);
        } else {
          chip.classList.toggle('is-active', state.sort.key === key);
        }
      });
    };

    const openModal = (item) => {
      modalTitle.textContent = item.name;
      const raw = item.desc || item.quote || item.description || 'No description provided yet.';
      modalDesc.innerHTML = formatRichText(raw);
      modalRarity.textContent = item.rarity;
      modalType.textContent = describeType(item.type);

      modalIcon.innerHTML = '';
      const key = rarityToKey(item.rarity);
      const colors = rarityConfig[key] || rarityConfig.default;
      modalIcon.style.setProperty('--rarity-color', colors.color);
      modalIcon.style.setProperty('--rarity-accent', colors.accent);

      const img = document.createElement('img');
      img.src = item.icon || buildIconPath(item.name);
      img.alt = `${item.name} icon`;
      img.onerror = () => {
        img.src = 'icons/.png';
      };
      modalIcon.appendChild(img);

      modal.classList.remove('is-hidden');
    };

    const closeModal = () => {
      modal.classList.add('is-hidden');
    };

    const sortComparator = (a, b) => {
      const secondary = state.sort.key === 'name'
        ? a.name.localeCompare(b.name)
        : (a.id || a.name).localeCompare(b.id || b.name);

      if (state.sort.rarity) {
        const rank = (r) => {
          const idx = rarityOrder.indexOf(r);
          return idx === -1 ? rarityOrder.length : idx;
        };
        const rarityDiff = rank(a.rarity) - rank(b.rarity);
        if (rarityDiff !== 0) return rarityDiff;
        if (secondary !== 0) return secondary;
        return (a.id || a.name).localeCompare(b.id || b.name);
      }

      if (secondary !== 0) return secondary;
      return (a.id || a.name).localeCompare(b.id || b.name);
    };

    const renderItems = () => {
      if (!items.length) {
        itemsGrid.innerHTML = '<p class="inline-error">No items found. Ensure ror2_items_and_equipments.json is present.</p>';
        document.querySelector('[data-result-count]').textContent = '0';
        document.querySelector('[data-active-count]').textContent = '0';
        return;
      }

      const filtered = items
        .filter((item) => {
          const matchesRarity =
            state.raritySelection.size === 0 || state.raritySelection.has(item.rarity);
          const matchesType =
            state.typeSelection.size === 0 || state.typeSelection.has(item.type);
          const matchesSearch =
            !state.search ||
            item.name.toLowerCase().includes(state.search) ||
            (item.desc || '').toLowerCase().includes(state.search) ||
            (item.quote || '').toLowerCase().includes(state.search);
          const isEnabled = item.enabled !== false;
          return matchesRarity && matchesType && matchesSearch && isEnabled;
        })
        .sort(sortComparator);

      document.querySelector('[data-result-count]').textContent = filtered.length;
      document.querySelector('[data-active-count]').textContent = filtered.filter((i) => i.type === 'equipment').length;

      itemsGrid.innerHTML = '';
      const frag = document.createDocumentFragment();

      filtered.forEach((item) => {
        const key = rarityToKey(item.rarity);
        const colors = rarityConfig[key] || rarityConfig.default;
        const card = cardTemplate.content.cloneNode(true);
        const article = card.querySelector('.item-card');
        article.style.setProperty('--rarity-color', colors.color);
        article.style.setProperty('--rarity-accent', colors.accent);
        article.dataset.rarity = item.rarity;
        article.dataset.type = item.type;
        article.dataset.name = item.name;
        article.dataset.description = item.desc || item.description || item.quote || '';
        article.dataset.icon = item.icon || '';
        article.dataset.id = item.id || '';

        const icon = card.querySelector('.item-icon');
        const img = document.createElement('img');
        img.src = item.icon || buildIconPath(item.name);
        img.alt = `${item.name} icon`;
        img.onerror = () => {
          img.src = 'icons/.png';
        };
        icon.appendChild(img);

        frag.appendChild(card);
      });

      if (!filtered.length) {
        itemsGrid.innerHTML = '<p class="inline-error">No items match your filters yet.</p>';
        return;
      }

      itemsGrid.appendChild(frag);
    };

    const attachFilters = () => {
      rarityFilters.addEventListener('click', (event) => {
        const chip = event.target.closest('.chip[data-rarity]');
        if (!chip) return;
        const value = chip.dataset.rarity;
        if (value === 'all') {
          state.raritySelection.clear();
        } else if (state.raritySelection.has(value)) {
          state.raritySelection.delete(value);
        } else {
          state.raritySelection.add(value);
        }
        syncChipStates();
        renderItems();
      });

      typeFilters.addEventListener('click', (event) => {
        const chip = event.target.closest('.chip[data-type]');
        if (!chip) return;
        const value = chip.dataset.type;
        if (value === 'all') {
          state.typeSelection.clear();
        } else if (state.typeSelection.has(value)) {
          state.typeSelection.delete(value);
        } else {
          state.typeSelection.add(value);
        }
        syncChipStates();
        renderItems();
      });

      sortToggles.addEventListener('click', (event) => {
        const chip = event.target.closest('.chip[data-sort]');
        if (!chip) return;
        const key = chip.dataset.sort;
        if (key === 'rarity') {
          state.sort.rarity = !state.sort.rarity;
        } else {
          state.sort.key = key; // choose one secondary sort
        }
        syncChipStates();
        renderItems();
      });

      searchInput.addEventListener('input', (event) => {
        state.search = event.target.value.trim().toLowerCase();
        renderItems();
      });

      itemsGrid.addEventListener('click', (event) => {
        const card = event.target.closest('.item-card');
        if (!card) return;
        openModal({
          name: card.dataset.name,
          description: card.dataset.description,
          rarity: card.dataset.rarity,
          type: card.dataset.type,
          icon: card.dataset.icon || buildIconPath(card.dataset.name),
        });
      });

      itemsGrid.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          const card = event.target.closest('.item-card');
          if (!card) return;
          event.preventDefault();
          openModal({
            name: card.dataset.name,
            description: card.dataset.description,
            rarity: card.dataset.rarity,
            type: card.dataset.type,
            icon: card.dataset.icon || buildIconPath(card.dataset.name),
          });
        }
      });

      modal.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal-backdrop') || event.target.classList.contains('modal-close')) {
          closeModal();
        }
      });

      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !modal.classList.contains('is-hidden')) {
          closeModal();
        }
      });
    };

    const loadItems = async () => {
      try {
        const response = await fetch('ror2_items_and_equipments.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        items = (Array.isArray(data) ? data : []).map((item) => ({
          ...item,
          enabled: item.enabled === false ? false : true,
        }));
        syncChipStates();
        renderItems();
      } catch (error) {
        itemsGrid.innerHTML = `<p class="inline-error">Couldn't load ror2_items_and_equipments.json (${error.message}).</p>`;
        document.querySelector('[data-result-count]').textContent = '0';
        document.querySelector('[data-active-count]').textContent = '0';
      }
    };

    attachFilters();
    loadItems();
  </script>
</body>
</html>
